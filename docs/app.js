class App{constructor(){new d1ce.Screen("info_screen").Print(d1ce.timestamp),this.log_screen=new d1ce.Screen("log_screen"),this.main_screen=new d1ce.Screen("main_screen"),this.touch_screen=new d1ce.Screen("touch_screen"),this.hand=new Hand(this.touch_screen),this.cubes=new Cubes(this.main_screen)}async Load(){await this.hand.Load(),await this.cubes.Load()}Store(){this.cubes.Store()}Update(){this.hand.Update(),this.hand.Tapped()?this.cubes.StartRolling():this.hand.Released()?this.hand.Released().Right()?this.cubes.StartChanging(1):this.hand.Released().Left()?this.cubes.StartChanging(-1):this.cubes.StartReleased():this.hand.Swiping()?this.hand.Swiping().Right()?this.cubes.StartHolding(1):this.hand.Swiping().Left()?this.cubes.StartHolding(-1):this.cubes.StartHolding(0):this.hand.Holding()?this.cubes.StartHolding(0):this.hand.Touching()&&this.cubes.StartSelecting(),this.cubes.Update()}Draw(){}async Main(){for(await this.Load();;)this.suspend?this.Store():(this.Update(),this.Draw(),await d1ce.Engine.Wait(1e3/60))}async Suspend(){for(this.suspend=!0;this.suspend;)await d1ce.Engine.Wait(1e3/60)}static Instance(){return null==this.instance&&(this.instance=new App),this.instance}}window.onload=(()=>App.Instance().Main()),document.visibilitychange=(()=>App.Instance().Suspend());class Hand{constructor(t){this.screen=t,this.input=new d1ce.Input(t),this.count=0,this.point=null,this.touching=null,this.holding=null,this.tapped=null,this.swiping=null,this.released=null}async Load(){this.point=new d1ce.Sprite("point"),this.point.LoadImage("data:image/svg+xml;charset=utf8,<svg viewBox='0 0 128 128' width='128' xmlns='http://www.w3.org/2000/svg'><circle cx='64' cy='64' r='32' stroke='silver' stroke-width='8' fill='none'/></svg>")}Touching(){return this.touching}StartTouching(){this.touching=this.input.Dirs(!0),this.input.Point()&&this.point.SetAnime("selecting")}Holding(){return this.holding}StartHolding(){this.holding=this.input.Dirs(!0),this.input.Point()&&this.point.SetAnime("holding")}Swiping(){return this.swiping}StartSwiping(){this.swiping=this.input.Dirs(!0),this.input.Point()&&this.point.SetAnime("swiping")}Tapped(){return this.tapped}StartTapped(){this.tapped=this.input.Dirs(),this.input.Point()&&this.point.SetAnime("decided")}Released(){return this.released}StartReleased(){this.released=this.input.Dirs(),this.input.Point()&&this.point.SetAnime("released")}Update(){this.touching=null,this.holding=null,this.tapped=null,this.swiping=null,this.released=null,this.input.UpdateDirs(1e3,2500,.5),null!=this.input.Dirs()?this.input.Dirs().IsEmpty()?this.StartTapped():this.StartReleased():null!=this.input.Dirs(!0)&&(this.input.Dirs(!0).Right()||this.input.Dirs(!0).Left()||this.input.Dirs(!0).Down()||this.input.Dirs(!0).Up()?this.StartSwiping():this.input.Dirs(!0).Far()?this.StartHolding():this.StartTouching()),this.input.Point()&&(this.point.SetPos(this.input.Point()),this.point.Enable(this.screen,!0))}}class Cubes{constructor(t){this.screen=t,this.sprites=null,this.query=new d1ce.Params(""),this.storage=new d1ce.Params(d1ce.identifier+"-option"),this.message=new d1ce.Params("*",!0),this.numbers=[],this.random=new d1ce.Count,this.update=null,this.count=0,this.app="",this.type="",this.type_count=1,this.type_number=6,this.seed=0,this.face="",this.fixed=null}async Load(){let t="image/dot.png",e=192;if(this.query.Value("app")&&(this.app=this.query.Value("app"),this.message.UpdateValue("app",this.app,!0),this.app.match(/^(\w+)@(\d+)/)?this.app.replace(/^(\w+)@(\d+)/,(s,i,h)=>{t="image/"+i+".png",e=Number(h)}):(t="image/"+this.app+".png",e=192)),this.query.Value("tag")){let t=this.query.Value("tag");this.message.UpdateValue("tag",t,!0)}this.sprites=[];for(let s=0;s<Cubes.count_max;++s)this.sprites[s]=new d1ce.Sprite("cubes"),this.sprites[s].LoadImage(t,e,e);for(let t=0;t<Cubes.count_max;++t)await this.sprites[t].WaitLoadingImage();if(null==this.query.Value("type")&&null==this.query.Value("seed")&&null==this.query.Value("face")||(this.type=this.query.Value("type"),this.seed=this.query.Value("seed"),this.face=this.query.Value("face")),this.query.Value("face")?this.fixed="face":this.query.Value("seed")?this.fixed="seed":this.query.Value("type")&&(this.fixed="type"),""==this.type&&(this.type=this.storage.Value("type"),this.seed=this.storage.Value("seed"),this.face=this.storage.Value("face")),null!=this.face){let t=this.face.split(",");this.numbers=[];for(let e=0;e<t.length;++e)isFinite(t[e])&&this.numbers.push(Number(t[e]));this.type=t.length+"d"}this.type.match(/(\d*)d(\d*)/)?this.type.replace(/(\d*)d(\d*)/,(t,e,s)=>{this.type_count=e>0?Number(e):1,this.type_number=s>0?Number(s):6}):isFinite(this.type)?(this.type_count=Number(this.type),this.type_number=6):(this.type="",this.type_count=1,this.type_number=6),this.type_count<1?this.type_count=1:this.type_count>Cubes.count_max&&(this.type_count=Cubes.count_max),this.type_number<1?this.type_number=1:this.type_number>Cubes.number_max&&(this.type_number=Cubes.number_max),isFinite(this.seed)||(this.seed=0),this.storage.UpdateValue("type",this.type),this.storage.UpdateValue("seed",this.seed),this.storage.UpdateValue("fixed",this.fixed),this.random=new d1ce.Count(this.seed);for(let t=0;t<Cubes.count_max;++t)this.sprites[t].Enable(this.screen,t<this.type_count),1==this.type_count?this.sprites[t].SetScale(1):this.type_count<=4?this.sprites[t].SetScale(.75):this.type_count<=9?this.sprites[t].SetScale(.5):this.sprites[t].SetScale(.375);if("face"==this.fixed)this.StartRolled();else if("seed"==this.fixed){this.numbers=[];for(let t=0;t<this.type_count;++t)this.numbers.push(this.random.Random(this.type_number)+1);this.StartRolled()}else this.StartSelecting()}Store(){}StartSelecting(){if("seed"!=this.fixed&&"face"!=this.fixed)if(this.update==this.UpdateSelecting){this.update=this.UpdateSelecting;for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("reselecting")}else{this.update=this.UpdateSelecting;for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("selecting")}}StartRolled(){this.update=this.UpdateRolled,this.count=0,this.storage.UpdateValue("type",this.type,!0),this.storage.UpdateValue("seed",this.seed,!0),this.storage.UpdateValue("face",this.face),this.query.UpdateValue("type",this.type,!0),this.query.UpdateValue("seed",this.seed,!0),this.query.UpdateValue("face",null),this.message.UpdateValue("type",this.type,!0),this.message.UpdateValue("seed",this.seed,!0);let t=this.numbers.join(",");this.message.UpdateValue("face",t);for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("rolled")}StartRolling(){if("seed"!=this.fixed&&"face"!=this.fixed){this.update=this.UpdateRolling,this.count=30;for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("rolling")}}StartHolding(t){if("seed"!=this.fixed&&"face"!=this.fixed)if("type"!=this.fixed){this.update!=this.UpdateHolding&&(this.update=this.UpdateHolding);for(let e=0;e<this.sprites.length;++e)t>0?this.sprites[e].SetAnime("swiping_right"):t<0?this.sprites[e].SetAnime("swiping_left"):this.sprites[e].SetAnime("holding")}else this.StartReleased()}StartReleased(){if("seed"!=this.fixed&&"face"!=this.fixed){this.update=this.UpdateSelecting;for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("released")}}StartChanging(t){if("seed"!=this.fixed&&"face"!=this.fixed)if("type"!=this.fixed){this.update=this.UpdateSelecting,t>0?this.type_count>=Cubes.count_max?this.type_count=Cubes.count_max:this.type_count=this.type_count+1:t<0&&(this.type_count<=1?this.type_count=1:this.type_count=this.type_count-1),0!=t&&(this.type=this.type_count+"d"+this.type_number,this.storage.UpdateValue("type",this.type),this.query.UpdateValue("type",this.type),this.message.UpdateValue("type",this.type,!0));for(let t=0;t<this.sprites.length;++t)this.sprites[t].Enable(this.screen,t<this.type_count),1==this.type_count?this.sprites[t].SetScale(1):this.type_count<=4?this.sprites[t].SetScale(.75):this.type_count<=9?this.sprites[t].SetScale(.5):this.sprites[t].SetScale(.375);for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("changed")}else this.StartReleased()}UpdateSelecting(){this.numbers=[];let t=Math.floor(this.count/20)%this.type_number+1;for(let e=0;e<this.sprites.length;++e)e<this.type_count&&this.numbers.push(t);for(let t=0;t<this.sprites.length;++t)t<this.type_count&&this.sprites[t].SetFrame(this.numbers[t]-1);this.count+=1}UpdateRolling(){this.numbers=[];for(let t=0;t<this.sprites.length;++t){let e=this.random.Random(this.type_number)+1;t<this.type_count&&this.numbers.push(e)}for(let t=0;t<this.sprites.length;++t)t<this.numbers.length&&this.sprites[t].SetFrame(this.numbers[t]-1);if(this.count-=1,this.count<=0){this.seed=this.random.Seed(),this.numbers=[];for(let t=0;t<this.type_count;++t)this.numbers.push(this.random.Random(this.type_number)+1);this.face="",this.StartRolled()}}UpdateRolled(){for(let t=0;t<this.sprites.length;++t)t<this.numbers.length&&this.sprites[t].SetFrame(this.numbers[t]-1);for(let t=0;t<this.sprites.length;++t)this.sprites[t].SetAnime("rolled")}UpdateHolding(){this.seed=0,this.numbers=[];let t=Math.floor(this.count/20)%this.type_number+1;for(let e=0;e<this.sprites.length;++e)e<this.type_count&&this.numbers.push(t);for(let t=0;t<this.sprites.length;++t)t<this.type_count&&this.sprites[t].SetFrame(this.numbers[t]-1);this.count+=1}Update(){null!=this.update&&this.update()}}Cubes.count_max=16,Cubes.number_max=54;